#!/bin/bash
# BetterDisplay sharing control script

CACHE_DIR="$HOME/.config/aerospace/.cache"
ENABLED_FILE="$CACHE_DIR/sharing-enabled"

MAIN_DISPLAY="Built-in Display"
VIRTUAL_DISPLAY="Sharing"

mkdir -p "$CACHE_DIR"

case "$1" in
    start)
        # Connect the virtual display
        echo "Connecting $VIRTUAL_DISPLAY virtual display"
        /Applications/BetterDisplay.app/Contents/MacOS/BetterDisplay set -name="$VIRTUAL_DISPLAY" -connected=on

        # Wait for virtual display to initialize
        sleep 0.5

        # Stream from main to virtual display
        echo "Streaming $MAIN_DISPLAY to $VIRTUAL_DISPLAY virtual display"
        /Applications/BetterDisplay.app/Contents/MacOS/BetterDisplay set -name="$MAIN_DISPLAY" -stream=on -targetName="$VIRTUAL_DISPLAY"

        # Get main display resolution and store in enabled file
        RESOLUTION=$(system_profiler SPDisplaysDataType | grep -A10 "Main Display: Yes" | grep "UI Looks like" | sed 's/.*UI Looks like: \([0-9]*\) x \([0-9]*\).*/\1 \2/')
        echo "$RESOLUTION" > "$ENABLED_FILE"

        # Initial run
        ./betterdisplay-sharing

        echo "BetterDisplay sharing enabled"
        ;;
    stop)
        # Disconnect the virtual display and remove flag
        echo "Disconnecting $VIRTUAL_DISPLAY virtual display"
        /Applications/BetterDisplay.app/Contents/MacOS/BetterDisplay set -name="$VIRTUAL_DISPLAY" -connected=off

        rm -f "$ENABLED_FILE"
        echo "BetterDisplay sharing disabled"
        ;;
    status)
        if [ -f "$ENABLED_FILE" ]; then
            echo "BetterDisplay sharing is enabled"
        else
            echo "BetterDisplay sharing is disabled"
        fi
        ;;
    *)
        echo "Usage: sharing {start|stop|status}"
        exit 1
        ;;
esac
